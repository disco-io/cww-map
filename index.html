<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>ArcGIS Maps SDK for JavaScript</title>

  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    #measurements {
      padding: 4px 8px;
      font-size: 16px;
      bottom: 15px;
      left: 50%;
      margin-right: -50%;
      transform: translate(-50%, -50%);
    }
  </style>

  <link rel="stylesheet" href="https://js.arcgis.com/4.27/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.27/"></script>

  <script>
    require([
      "esri/config",
      "esri/Map",
      "esri/views/MapView",
      "esri/widgets/BasemapToggle",
      "esri/widgets/BasemapGallery",
      "esri/widgets/Bookmarks",
      "esri/widgets/Expand",
      "esri/widgets/Search",
      "esri/layers/FeatureLayer",
      "esri/widgets/Popup",
      "esri/Graphic",
      "esri/widgets/ScaleBar",
      "esri/widgets/Sketch",
      "esri/layers/GraphicsLayer",
      "esri/geometry/geometryEngine"
    ], function (esriConfig, Map, MapView, BasemapToggle, BasemapGallery, Bookmarks, Expand, Search, FeatureLayer, Popup, Graphic, ScaleBar, Sketch, GraphicsLayer, geometryEngine) {

      esriConfig.apiKey = "AAPKae673c6809df470f95ee8b75b09a25ffrgMyhyBuUYUqrQOwRDjuNS8QSzgyVIQKo2nnbmh4u-WVAWNnufIBa7a_ySjV5vSd";

      const map = new Map({
        basemap: "arcgis-topographic"
      });

      const view = new MapView({
        map: map,
        center: [-76.1050, 37.5214], // Longitude, latitude
        zoom: 8.5, // Zoom level
        container: "viewDiv" // Div element
      });

      const scalebar = new ScaleBar({
        view: view,
        unit: "metric"
      });

      view.ui.add(scalebar, "bottom-right");

      const graphicsLayer = new GraphicsLayer();
      map.add(graphicsLayer);

      const sketch = new Sketch({
        layer: graphicsLayer,
        view: view,
        availableCreateTools: ["polyline", "polygon", "rectangle"],
        creationMode: "update",
        updateOnGraphicClick: true,
        visibleElements: {
          createTools: {
            point: false,
            circle: false
          },
          selectionTools: {
            "lasso-selection": false,
            "rectangle-selection": false,
          },
          settingsMenu: false,
          undoRedoMenu: false
        }
      });

      view.ui.add(sketch, "top-right");

      const measurements = document.getElementById("measurements");
      view.ui.add(measurements, "manual");

      const polygon = {
        type: "polygon",
        spatialReference: {
          wkid: 3857,
        },
        rings: [
          [
            [-4508069.082189632, 3599936.936171892],
            [-4508069.082189632, 5478453.343307884],
            [-2629552.6750536393, 5478453.343307884],
            [-2629552.6750536393, 3599936.936171892],
            [-4508069.082189632, 3599936.936171892],
          ],
        ],
      };

      const simplePolygonSymbol = {
        type: "simple-fill",
        outline: {
          color: [200, 0, 0],
          width: 2,
        },
      };

      const polygonGraphic = new Graphic({
        geometry: polygon,
        symbol: simplePolygonSymbol
      });

      graphicsLayer.add(polygonGraphic);

      view.when(() => {
        sketch.update(polygonGraphic);
        getArea(polygonGraphic.geometry);
      });

      sketch.on("update", (e) => {
        const geometry = e.graphics[0].geometry;

        if (e.state === "start") {
          switchType(geometry);
        }

        if (e.state === "complete") {
          graphicsLayer.remove(graphicsLayer.graphics.getItemAt(0));
          measurements.innerHTML = null;
        }

        if (
          e.toolEventInfo &&
          (e.toolEventInfo.type === "scale-stop" ||
            e.toolEventInfo.type === "reshape-stop" ||
            e.toolEventInfo.type === "move-stop")
        ) {
          switchType(geometry);
        }

      });

      function getArea(polygon) {
        const geodesicArea = geometryEngine.geodesicArea(polygon, "square-kilometers");
        const planarArea = geometryEngine.planarArea(polygon, "square-kilometers");

        measurements.innerHTML =
          "<b>Geodesic area</b>:  " + geodesicArea.toFixed(2) + " km²" + " |   <b>Planar area</b>: " + planarArea.toFixed(2) + "  km²";
      }

      function getLength(line) {
        const geodesicLength = geometryEngine.geodesicLength(line, "kilometers");
        const planarLength = geometryEngine.planarLength(line, "kilometers");

        measurements.innerHTML =
          "<b>Geodesic length</b>:  " + geodesicLength.toFixed(2) + " km" + " |   <b>Planar length</b>: " + planarLength.toFixed(2) + "  km";
      }

      function switchType(geom) {
        switch (geom.type) {
          case "polygon":
            getArea(geom);
            break;
          case "polyline":
            getLength(geom);
            break;
          default:
            console.log("No value found");
        }
      }

      const search = new Search({ //Add Search widget
        view: view
      });

      view.ui.add(search, "top-right"); //Add to the map

      const DocksLayer = new FeatureLayer({
        url: "https://services4.arcgis.com/tkyK8zdXvrUIsEhE/arcgis/rest/services/CWW_PART_THREE_WFL1/FeatureServer",
        outFields: ["*"],
        popupTemplate: {
          title: "{Dock_Name}",
          content: [{
            type: "fields",
            fieldInfos: [
              {
                fieldName: "Site Name",
                label: "Site Name"
              },
              {
                fieldName: "Grade",
                label: "Grade"
              },
              {
                fieldName: "County",
                label: "County"
              },
              {
                fieldName: "Water Body",
                label: "Water Body"
              },
              {
                fieldName: "Physical Address",
                label: "Physical Address",
              },
              {
                fieldName: "Hours",
                label: "Hours"
              },
              {
                fieldName: "Fee Or Permit Required",
                label: "Fee or Permit Required"
              },
              { 
                fieldName: "Contact Name",
                label: "Contact Name"
              },
              { 
                fieldName: "Owner Manager Facility Name",
                label: "Owner or Manager Facility Name"
              },
              { 
                fieldName: "Owner Manager Phone", 
                label: "Owner Or Manager Phone"
              },
              {
                fieldName: "Website",
                label: "Website"
              },
              {
                fieldName: "Directions",
                label: "Directions"
              },
              {
                fieldName: "Comments",
                label: "Comments"
              },
              {
                fieldName: "Questions And Updates",
                label: "Questions & Updates"
              },
            ]
          }]
        }
      });
      map.add(DocksLayer);

      DocksLayer.when(() => {
        view.goTo(DocksLayer.fullExtent);
      });

      view.whenLayerView(DocksLayer).then((layerView) => {
        layerView.watch("updating", (val) => {
          if (!val) {
            layerView.queryFeatures().then((results) => {
              results.forEach((feature) => {
                feature.popupTemplate = DocksLayer.popupTemplate;
                feature.popupTemplate.title = feature.attributes.Dock_Name;
              });
            });
          }
        });
      });

      const basemapGallery = new BasemapGallery({
        view: view,
        source: {
          query: {
            title: '"World Basemaps for Developers" AND owner:esri'
          }
        }
      });
      const bgExpand = new Expand({
        view: view,
        content: basemapGallery
      });

      view.ui.add(bgExpand, "bottom-right"); // Add to the view

      const bookmarks = new Bookmarks({
        view: view,
        // allows bookmarks to be added, edited, or deleted
        editingEnabled: true,
        visibleElements: {}
      });
      const bkExpand = new Expand({
        view: view,
        content: bookmarks,
      });

      // Add the widget to the top-right corner of the view
      view.ui.add(bkExpand, "top-right");
    });

  </script>

  </head>
  <body>
    <div id="viewDiv">

      <div id="measurements" class="esri-widget">

    </div>
  </div>
  </body>
</html>
